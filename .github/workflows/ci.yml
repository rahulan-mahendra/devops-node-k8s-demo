name: CI

on: 
    push:
        branches:
          - main
          - 'feature/**'
    pull_request:
        branches:
            - main
    workflow_dispatch:
      

jobs:
    unit-testing:
        name: Unit Testing
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Repo
            uses: actions/checkout@v4

          - name: Set up Node.js
            uses: actions/setup-node@v4
            with:
                node-version: '20'

          - name: Install Dependencies
            run: npm ci

          - name: Run Unit Test
            run: npm test

    build:
        name: Build Docker Image
        permissions:
            packages: write
            contents: read
        needs: [unit-testing]
        runs-on: ubuntu-latest
        steps:
          - name: Checkout Repo
            uses: actions/checkout@v4
         
          - name: Build Docker image
            run: docker build -t devops-node-k8s-demo:${{ github.sha }} .

          - name: Docker Image Testing
            env:
                APP_NAME: devops-node-k8s-demo
                APP_ENV: dev
                APP_VERSION: 0.0.0
            run: |
                docker images
                docker run -d -p 3000:3000 \
                -e APP_NAME=$APP_NAME \
                -e APP_ENV=$APP_ENV \
                -e APP_VERSION=$APP_VERSION \
                --name node-app \
                devops-node-k8s-demo:${{ github.sha }}

                sleep 5
                curl -f http://localhost:3000/health
                docker rm -f node-app

          - name: GHCR Login
            uses: docker/login-action@v2.2.0
            with:
                registry: ghcr.io
                username: ${{ github.repository_owner }}
                password: ${{ secrets.GITHUB_TOKEN }}

          - name: Container Registry Push
            uses: docker/build-push-action@v4
            with:
                context: .
                push: true
                tags: |
                    ghcr.io/${{ github.repository_owner }}/devops-node-k8s-demo:${{ github.sha }}
                    ghcr.io/${{ github.repository_owner }}/devops-node-k8s-demo:latest

    deploy:
      name: Deploy to Kubernetes
      needs: [build]
      runs-on: self-hosted

      if: github.event_name == 'workflow_dispatch'

      steps:
        - name: Checkout repo
          uses: actions/checkout@v4

        - name: Setup kubectl
          uses: azure/setup-kubectl@v3
          with:
            version: 'latest'
            
        - name: Fetch Kubernetes Cluster Details
          run: |
            kubectl version --client
            kubectl get nodes

        - name: Deploy manifests
          run: |
            kubectl apply -f kubernetes/configmap.yaml
            kubectl apply -f kubernetes/deployment.yaml
            kubectl apply -f kubernetes/service.yaml
            kubectl rollout status deployment/devops-demo